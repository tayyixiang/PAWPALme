@page "/shelter/pets/edit/{Id:int?}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using PAWPALme.Models
@using PAWPALme.Data
@using PAWPALme.Repositories
@using PAWPALme.Enums
@attribute [Authorize(Roles = "Shelter")]
@inject IPetRepository PetRepo
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<div class="container mt-4">
    <div class="card shadow-sm mx-auto" style="max-width: 800px;">
        <div class="card-header bg-white d-flex align-items-center">
            <a href="shelter/pets" class="btn btn-outline-secondary btn-sm me-3"><i class="bi bi-arrow-left"></i> Back</a>
            <h3 class="mb-0">@(Id.HasValue ? "Edit Pet Profile" : "Add New Pet")</h3>
        </div>
        <div class="card-body">
            <EditForm Model="PetModel" OnValidSubmit="SavePet">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Name</label>
                        <InputText @bind-Value="PetModel.Name" class="form-control" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Species</label>
                        <InputSelect @bind-Value="PetModel.Species" class="form-select">
                            <option value="Dog">Dog</option>
                            <option value="Cat">Cat</option>
                        </InputSelect>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Breed</label>
                        <InputText @bind-Value="PetModel.Breed" class="form-control" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Age</label>
                        <InputNumber @bind-Value="PetModel.Age" class="form-control" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Gender</label>
                        <InputSelect @bind-Value="PetModel.Gender" class="form-select">
                            <option value="@PetGender.Male">Male</option>
                            <option value="@PetGender.Female">Female</option>
                        </InputSelect>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Size</label>
                        <InputSelect @bind-Value="PetModel.Size" class="form-select">
                            <option value="Small">Small</option>
                            <option value="Medium">Medium</option>
                            <option value="Large">Large</option>
                        </InputSelect>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Image URL</label>
                        <InputText @bind-Value="PetModel.ImageUrl" class="form-control" placeholder="https://..." />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <InputTextArea @bind-Value="PetModel.Description" class="form-control" rows="4" />
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">Save Pet Profile</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public int? Id { get; set; }
    private Pet PetModel { get; set; } = new() { Species = "Dog" }; // Default to Dog
    private ApplicationUser? currentUser;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUser = await UserManager.GetUserAsync(authState.User);

        if (Id.HasValue)
        {
            var existing = await PetRepo.GetByIdAsync(Id.Value);
            // Ensure ownership
            if (existing != null && existing.ShelterId == currentUser?.ShelterId)
            {
                PetModel = existing;
            }
        }
    }

    private async Task SavePet()
    {
        if (currentUser?.ShelterId == null) return;

        PetModel.ShelterId = currentUser.ShelterId.Value;

        if (Id.HasValue)
        {
            await PetRepo.UpdateAsync(PetModel);
        }
        else
        {
            await PetRepo.AddAsync(PetModel);
        }

        Nav.NavigateTo("/shelter/pets");
    }
}