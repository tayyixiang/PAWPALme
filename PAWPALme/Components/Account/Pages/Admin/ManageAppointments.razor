@page "/shelter/appointments"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using PAWPALme.Models
@using PAWPALme.Data
@using PAWPALme.Repositories
@using PAWPALme.Enums
@attribute [Authorize(Roles = "Shelter")]
@inject IAppointmentRepository ApptRepo
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider

<div class="container mt-4">
    <h3>Appointment Requests</h3>

    @if (appointments == null)
    {
        <p>Loading...</p>
    }
    else if (!appointments.Any())
    {
        <div class="alert alert-info">No pending appointments.</div>
    }
    else
    {
        <table class="table align-middle">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Pet</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var appt in appointments)
                {
                    <tr>
                        <td>@appt.AppointmentDate.ToShortDateString()</td>
                        <td>@appt.AppointmentTime.ToString(@"hh\:mm")</td>
                        <td>@appt.Pet?.Name</td>
                        <td>
                            @* Fix: Use GetBadgeClass to handle the Enum *@
                            <span class="badge @GetBadgeClass(appt.Status)">@appt.Status</span>
                        </td>
                        <td>
                            @* Fix: Compare against Enum, not string *@
                            @if (appt.Status == AppointmentStatus.Pending)
                            {
                                <button class="btn btn-sm btn-success me-2" @onclick="() => UpdateStatus(appt, AppointmentStatus.Confirmed)">Approve</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => UpdateStatus(appt, AppointmentStatus.Cancelled)">Deny</button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    private IEnumerable<Appointment>? appointments;
    private ApplicationUser? currentUser;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUser = await UserManager.GetUserAsync(authState.User);

        if (currentUser?.ShelterId != null)
        {
            appointments = await ApptRepo.GetByShelterIdAsync(currentUser.ShelterId.Value);
        }
    }

    // Fix: Parameter must be Enum, not int/string
    private async Task UpdateStatus(Appointment appt, AppointmentStatus status)
    {
        appt.Status = status;
        await ApptRepo.UpdateAsync(appt);
        // Refresh list
        if (currentUser?.ShelterId != null)
        {
            appointments = await ApptRepo.GetByShelterIdAsync(currentUser.ShelterId.Value);
        }
    }

    // Fix: Switch on Enum
    private string GetBadgeClass(AppointmentStatus status) => status switch
    {
        AppointmentStatus.Confirmed => "bg-success",
        AppointmentStatus.Cancelled => "bg-danger",
        AppointmentStatus.Pending => "bg-warning text-dark",
        _ => "bg-secondary"
    };
}
