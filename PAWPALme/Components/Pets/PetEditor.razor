@* ROUTING: 
   This component listens to TWO different URLs.
   1. ".../add" -> No ID provided -> We assume CREATE mode.
   2. ".../edit/5" -> ID provided -> We assume EDIT mode.
   This saves us from maintaining two nearly identical files.
*@
@page "/shelter/pets/add"
@page "/shelter/pets/edit/{Id:int}"

@using Microsoft.AspNetCore.Authorization
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Services
@using PAWPALme.Enums
@using PAWPALme.Data
@using Microsoft.AspNetCore.Identity

@* SECURITY: Strict access control. Only Shelter accounts can touch this page. *@
@attribute [Authorize(Roles = "Shelter")]
@rendermode InteractiveServer

@inject IPetRepository PetRepo
@inject IShelterRepository ShelterRepo
@inject IFileService FileService
@inject NavigationManager Nav
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider

@* UX: Dynamic Page Title. Changes based on what the user is doing. *@
<PageTitle>@(Id == null ? "Add New Pet" : "Edit Pet")</PageTitle>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card form-card">
                <div class="card-header bg-white border-bottom-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                    <h3 class="fw-bold text-primary mb-0">@(Id == null ? "Add a New Pet" : $"Edit {PetModel.Name}")</h3>

                    @* DANGER ZONE: 
                       We only show the "Delete" button if we are in Edit Mode (ID exists).
                       You can't delete a pet you haven't created yet.
                    *@
                    @if (Id.HasValue)
                    {
                        <button class="btn btn-outline-danger btn-sm" type="button" @onclick="DeletePet">
                            <i class="bi bi-trash me-1"></i> Delete Pet
                        </button>
                    }
                </div>

                <div class="card-body p-4">
                    @* FORM:
                       We bind the form to 'PetModel'. When the user types, it updates this object instantly.
                       'OnValidSubmit' ensures 'SavePet' only runs if all [Required] fields are filled.
                    *@
                    <EditForm Model="PetModel" OnValidSubmit="SavePet" FormName="pet-editor">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger mb-3" />

                        <div class="row">
                            @* --- LEFT COLUMN: IMAGE UPLOAD --- *@
                            <div class="col-md-5 mb-4">
                                <label class="form-label fw-bold">Pet Photo</label>
                                <div class="image-upload-area">
                                    @* PREVIEW LOGIC:
                                       If we have an image URL (either from DB or just uploaded), show it.
                                       Otherwise, show the "Cloud Upload" icon.
                                    *@
                                    @if (!string.IsNullOrEmpty(PetModel.ImageUrl))
                                    {
                                        <img src="@PetModel.ImageUrl" class="preview-img" />
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-2" @onclick="() => PetModel.ImageUrl = null">
                                            Remove Photo
                                        </button>
                                    }
                                    else
                                    {
                                        <div class="upload-overlay">
                                            <i class="bi bi-cloud-upload fs-1"></i>
                                            <p class="mt-2">Click to upload photo</p>
                                        </div>
                                    }
                                    @* INPUT FILE:
                                       This is the invisible trigger. When a user selects a file, 
                                       'HandleFileSelected' fires immediately to upload it.
                                    *@
                                    <InputFile OnChange="HandleFileSelected" class="position-absolute w-100 h-100 top-0 start-0 opacity-0" accept=".jpg,.png,.jpeg" />
                                </div>

                                @* PROGRESS INDICATOR: Shows while the image is being sent to the server *@
                                @if (isUploading)
                                {
                                    <div class="progress mt-2" style="height: 5px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated w-100"></div>
                                    </div>
                                    <small class="text-muted">Uploading...</small>
                                }
                            </div>

                            @* --- RIGHT COLUMN: TEXT FIELDS --- *@
                            <div class="col-md-7">
                                <div class="mb-3">
                                    <label class="form-label">Name</label>
                                    <InputText @bind-Value="PetModel.Name" class="form-control" placeholder="Pet's Name" />
                                </div>

                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <label class="form-label">Species</label>
                                        <InputSelect @bind-Value="PetModel.Species" class="form-select">
                                            <option value="">-- Select --</option>
                                            <option value="Dog">Dog</option>
                                            <option value="Cat">Cat</option>
                                            <option value="Rabbit">Rabbit</option>
                                            <option value="Bird">Bird</option>
                                            <option value="Other">Other</option>
                                        </InputSelect>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <label class="form-label">Breed</label>
                                        <InputText @bind-Value="PetModel.Breed" class="form-control" placeholder="e.g. Golden Retriever" />
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-4 mb-3">
                                        <label class="form-label">Age (Yrs)</label>
                                        <InputNumber @bind-Value="PetModel.Age" class="form-control" />
                                    </div>
                                    <div class="col-4 mb-3">
                                        <label class="form-label">Gender</label>
                                        <InputSelect @bind-Value="PetModel.Gender" class="form-select">
                                            @* Using ENUM values here for type safety *@
                                            <option value="@PetGender.Male">Male</option>
                                            <option value="@PetGender.Female">Female</option>
                                        </InputSelect>
                                    </div>
                                    <div class="col-4 mb-3">
                                        <label class="form-label">Size</label>
                                        <InputSelect @bind-Value="PetModel.Size" class="form-select">
                                            <option value="Small">Small</option>
                                            <option value="Medium">Medium</option>
                                            <option value="Large">Large</option>
                                        </InputSelect>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <InputTextArea @bind-Value="PetModel.Description" class="form-control" rows="5" placeholder="Tell us about their personality..." />
                                </div>

                                @* ADOPTION TOGGLE:
                                   This is a quick way to change status without a dropdown.
                                   It changes the visual status of the pet in the public list.
                                *@
                                <div class="form-check mb-4">
                                    <input type="checkbox" class="form-check-input" id="adoptedCheck"
                                           checked="@(PetModel.Status == PetStatus.Adopted)"
                                           @onchange="ToggleAdoptedStatus" />
                                    <label class="form-check-label" for="adoptedCheck">
                                        Mark as Adopted (Hidden from public listings)
                                    </label>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <a href="shelter/pets" class="btn btn-secondary">Cancel</a>
                                    <button type="submit" class="btn btn-primary px-4">Save Pet</button>
                                </div>
                            </div>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // URL PARAMETER:
    // This variable catches the "edit/{Id}" part of the URL.
    // If we are creating, this will be null.
    [Parameter] public int? Id { get; set; }

    [SupplyParameterFromForm]
    private Pet PetModel { get; set; } = new();

    private bool isUploading = false;
    private int? userShelterId;

    protected override async Task OnInitializedAsync()
    {
        // 1. DETERMINE MODE (Create vs Edit)
        // Check if we are loading fresh (PetModel.Id == 0) and if an ID was passed in URL.
        if (PetModel.Id == 0 && Id.HasValue)
        {
            // --- EDIT MODE LOGIC ---

            // A. Identity Check: Get current logged-in user
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = await UserManager.GetUserAsync(authState.User);
            userShelterId = user?.ShelterId;

            // Safety: If user has no shelter profile, redirect them to register one.
            if (userShelterId == null)
            {
                Nav.NavigateTo("/shelter/register");
                return;
            }

            // B. Database Fetch
            var existingPet = await PetRepo.GetByIdAsync(Id.Value);

            if (existingPet != null)
            {
                // C. OWNERSHIP SECURITY CHECK (CRITICAL):
                // We must verify that the logged-in Shelter actually OWNS the pet they are trying to edit.
                // Otherwise, Shelter A could guess the ID of Shelter B's pet and edit it.
                if (existingPet.ShelterId != userShelterId)
                {
                    Nav.NavigateTo("/shelter/pets"); // Kick them out if they don't own it.
                    return;
                }
                PetModel = existingPet; // Load data into the form
            }
        }
        else if (!Id.HasValue)
        {
            // --- CREATE MODE LOGIC ---
            // Just set some sensible defaults for the dropdowns.
            PetModel.Species = "Dog";
            PetModel.Size = "Medium";
            PetModel.Status = PetStatus.Available;
        }
    }

    // HELPER: Simple toggle logic for the checkbox
    private void ToggleAdoptedStatus(ChangeEventArgs e)
    {
        bool isAdopted = (bool)(e.Value ?? false);
        PetModel.Status = isAdopted ? PetStatus.Adopted : PetStatus.Available;
    }

    // UPLOAD LOGIC:
    // Delegates the actual file saving to our 'FileService' to keep this file clean.
    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        isUploading = true;
        try
        {
            // The service returns the public URL path (e.g. "/uploads/pets/image.jpg")
            var path = await FileService.UploadFileAsync(e.File, "pets");
            PetModel.ImageUrl = path;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Upload Error: {ex.Message}");
        }
        isUploading = false;
    }

    // SAVE LOGIC: Handles both Insert and Update
    private async Task SavePet()
    {
        // Double-check authentication before saving
        if (userShelterId == null)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = await UserManager.GetUserAsync(authState.User);
            userShelterId = user?.ShelterId;
        }

        if (userShelterId == null) return;

        // FORCE ASSIGNMENT:
        // Ensure the pet is linked to the current user's shelter, regardless of what the form says.
        PetModel.ShelterId = userShelterId.Value;

        if (PetModel.Id == 0)
        {
            // ID is 0, so this is a NEW pet -> INSERT
            await PetRepo.AddAsync(PetModel);
        }
        else
        {
            // ID exists, so this is an EXISTING pet -> UPDATE
            await PetRepo.UpdateAsync(PetModel);
        }

        Nav.NavigateTo("shelter/pets");
    }

    private async Task DeletePet()
    {
        if (PetModel.Id > 0)
        {
            await PetRepo.DeleteAsync(PetModel.Id);
            Nav.NavigateTo("shelter/pets", forceLoad: true); // Force reload to refresh the grid
        }
    }
}