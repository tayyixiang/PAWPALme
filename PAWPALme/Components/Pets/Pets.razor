@page "/pets"
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Enums
@using Microsoft.AspNetCore.Components.Authorization
@inject IPetRepository PetRepo
@inject NavigationManager Nav
@* FIX 1: Enable Interactive Mode so search/filter works instantly *@
@rendermode InteractiveServer

<PageTitle>Browse Pets | PawPal</PageTitle>

<div class="container py-4">

    <div class="row justify-content-center mb-5">
        <div class="col-lg-10">
            <div class="neumorph-bar d-flex gap-3 align-items-center p-3 flex-wrap">
                <i class="bi bi-search text-primary fs-4 ms-2"></i>

                <input type="text" class="form-input flex-grow-1"
                       placeholder="Search keywords (e.g. 'Playful Golden Retriever')"
                       @bind="SearchTerm"
                       @bind:event="oninput"
                       @bind:after="FilterPets" />

                <select class="form-input w-auto" @bind="SelectedSpecies" @bind:after="FilterPets">
                    <option value="">All Species</option>
                    @foreach (var species in _speciesList)
                    {
                        <option value="@species">@species</option>
                    }
                </select>
            </div>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2 text-muted">Loading pets...</p>
        </div>
    }
    else if (!_filteredPets.Any())
    {
        <div class="text-center py-5 text-muted">
            <i class="bi bi-search fs-1 opacity-50"></i>
            <h4 class="mt-3 fw-bold">No pets found</h4>
            <p>Try adjusting your search terms or filters.</p>
            <button class="btn btn-link" @onclick="ClearFilters">Clear all filters</button>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var pet in _filteredPets)
            {
                <div class="col-md-4 col-sm-6 col-lg-3">
                    <div class="pet-liquid-card h-100">
                        <div class="img-container">
                            @if (!string.IsNullOrEmpty(pet.ImageUrl))
                            {
                                <img src="@pet.ImageUrl" alt="@pet.Name" />
                            }
                            else
                            {
                                <div class="placeholder-img">
                                    <i class="bi bi-camera"></i>
                                </div>
                            }

                            @if (pet.Status == PetStatus.Adopted)
                            {
                                <span class="status-badge bg-success">Adopted</span>
                            }
                            else
                            {
                                <span class="status-badge bg-primary">Available</span>
                            }
                        </div>

                        <div class="card-body mt-3 text-center">
                            <h5 class="fw-bold mb-1">@pet.Name</h5>
                            <p class="text-muted small mb-3">@pet.Breed • @pet.Age yrs</p>

                            <a href="pet/@pet.Id" class="liquid-btn text-decoration-none d-block py-2">
                                Meet Me
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private IEnumerable<Pet> _allPets = new List<Pet>();
    private IEnumerable<Pet> _filteredPets = new List<Pet>();
    private bool _isLoading = true;

    // Search State
    private string SearchTerm { get; set; } = "";
    private string SelectedSpecies { get; set; } = "";

    // Hardcoded list (Matches your previous file)
    private List<string> _speciesList = new() { "Dog", "Cat", "Rabbit", "Bird", "Other" };

    protected override async Task OnInitializedAsync()
    {
        // Simulate slight delay to prevent UI flicker
        await Task.Delay(100);
        _allPets = await PetRepo.GetAllAsync();

        // Initial filter (Show only Available pets by default, or all? Usually all for Browse)
        // Let's show all initially.
        _filteredPets = _allPets;
        _isLoading = false;
    }

    private void FilterPets()
    {
        var query = _allPets;

        // 1. Species Filter (Exact Match)
        if (!string.IsNullOrEmpty(SelectedSpecies))
        {
            query = query.Where(p => p.Species.Equals(SelectedSpecies, StringComparison.OrdinalIgnoreCase));
        }

        // 2. Keyword Search (Smart Search)
        if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            // Split search into words (e.g., "Golden Retriever" -> ["Golden", "Retriever"])
            var keywords = SearchTerm.Split(' ', StringSplitOptions.RemoveEmptyEntries);

            query = query.Where(p =>
            {
                // Combine all searchable text fields
                var searchableText = $"{p.Name} {p.Breed} {p.Description} {p.Size} {p.Gender}".ToLower();

                // Check if ALL keywords are present in the text
                return keywords.All(k => searchableText.Contains(k.ToLower()));
            });
        }

        _filteredPets = query.ToList();
    }

    private void ClearFilters()
    {
        SearchTerm = "";
        SelectedSpecies = "";
        FilterPets();
    }
}