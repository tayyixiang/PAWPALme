@page "/pets"
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Enums
@using Microsoft.AspNetCore.Components.Authorization
@inject IPetRepository PetRepo
@inject NavigationManager Nav

@* RENDER MODE: 
   This must be InteractiveServer because we use @bind and filtering events.
   Static rendering would mean the search bar wouldn't react to typing.
*@
@rendermode InteractiveServer

<PageTitle>Browse Pets | PawPal</PageTitle>

<div class="container py-4">

    @* --- SEARCH BAR SECTION --- *@
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10">
            <div class="neumorph-bar d-flex gap-3 align-items-center p-3 flex-wrap">
                <i class="bi bi-search text-primary fs-4 ms-2"></i>

                @* REAL-TIME SEARCH:
                   @bind:event="oninput" makes the search trigger on every keystroke,
                   not just when the user presses Enter or clicks away.
                   @bind:after="FilterPets" runs the filter logic instantly after the value updates.
                *@
                <input type="text" class="form-input flex-grow-1"
                       placeholder="Search keywords (e.g. 'Playful Golden Retriever')"
                       @bind="SearchTerm"
                       @bind:event="oninput"
                       @bind:after="FilterPets" />

                @* DROPDOWN FILTER:
                   This also triggers FilterPets immediately upon selection.
                *@
                <select class="form-input w-auto" @bind="SelectedSpecies" @bind:after="FilterPets">
                    <option value="">All Species</option>
                    @foreach (var species in _speciesList)
                    {
                        <option value="@species">@species</option>
                    }
                </select>
            </div>
        </div>
    </div>

    @* --- CONTENT LOADING STATES --- *@
    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2 text-muted">Loading pets...</p>
        </div>
    }
    @* EMPTY STATE: Only shown if loading is done AND list is empty *@
    else if (!_filteredPets.Any())
    {
        <div class="text-center py-5 text-muted">
            <i class="bi bi-search fs-1 opacity-50"></i>
            <h4 class="mt-3 fw-bold">No pets found</h4>
            <p>Try adjusting your search terms or filters.</p>
            <button class="btn btn-link" @onclick="ClearFilters">Clear all filters</button>
        </div>
    }
    else
    {
        @* --- PET GRID --- *@
        <div class="row g-4">
            @foreach (var pet in _filteredPets)
            {
                <div class="col-md-4 col-sm-6 col-lg-3">
                    <div class="pet-liquid-card h-100">
                        <div class="img-container">
                            @* Image Handling: Only try to load if URL exists *@
                            @if (!string.IsNullOrEmpty(pet.ImageUrl))
                            {
                                <img src="@pet.ImageUrl" alt="@pet.Name" />
                            }
                            else
                            {
                                <div class="placeholder-img">
                                    <i class="bi bi-camera"></i>
                                </div>
                            }

                            @* STATUS BADGES: Visual indicators for availability *@
                            @if (pet.Status == PetStatus.Adopted)
                            {
                                <span class="status-badge bg-success">Adopted</span>
                            }
                            else
                            {
                                <span class="status-badge bg-primary">Available</span>
                            }
                        </div>

                        <div class="card-body mt-3 text-center">
                            <h5 class="fw-bold mb-1">@pet.Name</h5>
                            <p class="text-muted small mb-3">@pet.Breed • @pet.Age yrs</p>

                            @* ROUTING FIX: Plural "pets/" ensures correct navigation to Detail Page *@
                            <a href="pets/@pet.Id" class="liquid-btn text-decoration-none d-block py-2">
                                Meet Me
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    // DATA COLLECTIONS:
    // _allPets: The master copy of data fetched from DB. Never modified after load.
    // _filteredPets: The subset currently shown on screen. Modified by search logic.
    private IEnumerable<Pet> _allPets = new List<Pet>();
    private IEnumerable<Pet> _filteredPets = new List<Pet>();
    private bool _isLoading = true;

    // SEARCH STATE
    private string SearchTerm { get; set; } = "";
    private string SelectedSpecies { get; set; } = "";

    // CONFIGURATION: Hardcoded list for the dropdown filter
    private List<string> _speciesList = new() { "Dog", "Cat", "Rabbit", "Bird", "Other" };

    protected override async Task OnInitializedAsync()
    {
        // Simulate slight delay for smoother UI transition (optional, can be removed)
        await Task.Delay(100);

        // Fetch all pets ONCE.
        // We filter in memory (client-side) rather than hitting the database for every keystroke.
        // This is much faster for lists under ~1000 items.
        _allPets = await PetRepo.GetAllAsync();
        _filteredPets = _allPets;
        _isLoading = false;
    }

    // CORE FILTERING LOGIC
    private void FilterPets()
    {
        var query = _allPets;

        // 1. Apply Species Filter (if selected)
        if (!string.IsNullOrEmpty(SelectedSpecies))
        {
            query = query.Where(p => p.Species.Equals(SelectedSpecies, StringComparison.OrdinalIgnoreCase));
        }

        // 2. Apply Keyword Search (if typed)
        if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            var keywords = SearchTerm.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            query = query.Where(p =>
            {
                // CONCATENATION:
                // We combine all searchable fields into one string.
                // This allows a user to search "Golden Male" and find a "Golden Retriever" that is "Male".
                var searchableText = $"{p.Name} {p.Breed} {p.Description} {p.Size} {p.Gender}".ToLower();

                // .All(k => ...) ensures ALL typed words must exist in the pet's profile.
                return keywords.All(k => searchableText.Contains(k.ToLower()));
            });
        }

        _filteredPets = query.ToList(); // Update the UI
    }

    // RESET FUNCTION
    private void ClearFilters()
    {
        SearchTerm = "";
        SelectedSpecies = "";
        FilterPets(); // Re-run filter to restore full list
    }
}