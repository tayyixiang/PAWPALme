@page "/book-appointment/{PetId:int}"
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Enums
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@inject IAppointmentRepository ApptRepo
@inject IPetRepository PetRepo
@inject NavigationManager Nav

@* SECURITY: The [Authorize] attribute ensures only logged-in users can access this page. 
    If they aren't logged in, they are automatically redirected to the login screen.
*@
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Book Visit | PawPal</PageTitle>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            <div class="glass-card p-5">

                <div class="text-center mb-5">
                    <h2 class="fw-bold text-primary">Book a Visit</h2>
                    <p class="text-muted">Schedule a time to meet your future best friend.</p>
                </div>

                @* LOADING CHECK:
                    Since we fetch data asynchronously, 'PetModel' starts as null.
                    We show a loading spinner until the data arrives to prevent errors.
                *@
                @if (PetModel == null)
                {
                    <div class="text-center"><div class="spinner-border text-primary"></div></div>
                }
                else
                {
                    @* PET INFO CARD: A small summary so the user knows who they are booking for. *@
                    <div class="d-flex align-items-center bg-white rounded-pill p-2 shadow-sm mb-4">
                        <img src="@(PetModel.ImageUrl ?? "/images/pet-placeholder.png")"
                             class="rounded-circle" width="60" height="60" style="object-fit:cover" />
                        <div class="ms-3">
                            <h5 class="fw-bold mb-0 text-dark">@PetModel.Name</h5>
                            <small class="text-muted">@PetModel.Breed • @PetModel.Age yrs</small>
                        </div>
                    </div>

                    @* FORM START:
                        We use EditForm for built-in validation support.
                        'OnValidSubmit' ensures the 'SubmitBooking' function only runs if all fields are valid.
                    *@
                    <EditForm Model="Input" OnValidSubmit="SubmitBooking" FormName="book-appointment">
                        <DataAnnotationsValidator />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="ms-3 mb-1 small fw-bold text-muted">Date</label>
                                <div class="input-group-custom">
                                    <i class="bi bi-calendar-event input-icon"></i>
                                    @* Binds to the Date property in our input model *@
                                    <InputDate @bind-Value="Input.Date" class="form-input" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="ms-3 mb-1 small fw-bold text-muted">Time</label>
                                <div class="input-group-custom">
                                    <i class="bi bi-clock input-icon"></i>
                                    @* InputDateType.Time forces the browser to show a time picker *@
                                    <InputDate Type="InputDateType.Time" @bind-Value="Input.Time" class="form-input" />
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="ms-3 mb-1 small fw-bold text-muted">Message to Shelter</label>
                                <div class="input-group-custom">
                                    <i class="bi bi-chat-text input-icon" style="top: 20px;"></i>
                                    <InputTextArea @bind-Value="Input.Notes" class="form-input" rows="4" placeholder="e.g. I have a large yard and two cats..." />
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            @* Cancel button takes them back to the pet details page *@
                            <a href="pet/@PetId" class="btn btn-link text-decoration-none text-muted fw-bold">Cancel</a>
                            <button type="submit" class="liquid-btn flex-grow-1">
                                Confirm Booking
                            </button>
                        </div>
                    </EditForm>
                }
            </div>

        </div>
    </div>
</div>

@code {
    // CAPTURE URL DATA: This gets the 'PetId' number from the browser address bar.
    [Parameter] public int PetId { get; set; }

    // FORM MODEL:
    // We use a specific class 'BookingInput' to capture form data.
    // 'SupplyParameterFromForm' ensures data isn't lost if the page reloads.
    [SupplyParameterFromForm]
    private BookingInput Input { get; set; } = new();

    private Pet? PetModel;
    private string? UserId;

    protected override async Task OnInitializedAsync()
    {
        // 1. IDENTIFY USER:
        // We look at the current authentication state to get the logged-in user's unique ID.
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        UserId = authState.User.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;

        // 2. FETCH PET DATA:
        // We use the PetRepository to get details about the pet being booked.
        if (PetId > 0)
        {
            PetModel = await PetRepo.GetByIdAsync(PetId);
            // Safety: If the ID is invalid (pet doesn't exist), redirect to the list page.
            if (PetModel == null) Nav.NavigateTo("/pets");
        }

        // 3. SET DEFAULTS:
        // Pre-fill the date picker to 'Tomorrow' so the user doesn't start with a blank field.
        if (Input.Date == default) Input.Date = DateTime.Now.AddDays(1);
    }

    private async Task SubmitBooking()
    {
        // Final check to ensure we have both the Pet and User info before saving.
        if (PetModel != null && UserId != null)
        {
            // CREATE ENTITY:
            // We transfer data from the Form (Input) into the Database Object (Appointment).
            var appointment = new Appointment
            {
                PetId = PetModel.Id,
                ShelterId = PetModel.ShelterId, // Links the appointment to the correct shelter
                AdopterUserId = UserId,         // Links the appointment to the current user
                AppointmentDate = Input.Date,
                AppointmentTime = Input.Time.TimeOfDay, // Extracts just the time part (HH:mm)
                Notes = Input.Notes,
                Status = AppointmentStatus.Pending // New appointments always start as Pending
            };

            // SAVE TO DB:
            // The repository handles the actual SQL Insert command.
            await ApptRepo.AddAsync(appointment);

            // REDIRECT:
            // Send the user to their personal dashboard to confirm the booking appeared.
            Nav.NavigateTo("my-appointments");
        }
    }

    // INPUT MODEL CLASS:
    // This defines exactly what fields appear on the form and their validation rules.
    public class BookingInput
    {
        [Required] // User must pick a date
        public DateTime Date { get; set; }

        [Required] // User must pick a time
        public DateTime Time { get; set; } = DateTime.Today.AddHours(10); // Defaults to 10:00 AM

        [StringLength(500)] // Limits the text to prevent database overflow
        public string? Notes { get; set; }
    }
}