@page "/book-appointment/{PetId:int}"
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Enums
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@inject IAppointmentRepository ApptRepo
@inject IPetRepository PetRepo
@inject NavigationManager Nav
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Book Visit | PawPal</PageTitle>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            <div class="glass-card p-5">

                <div class="text-center mb-5">
                    <h2 class="fw-bold text-primary">Book a Visit</h2>
                    <p class="text-muted">Schedule a time to meet your future best friend.</p>
                </div>

                @if (PetModel == null)
                {
                    <div class="text-center"><div class="spinner-border text-primary"></div></div>
                }
                else
                {
                    <div class="d-flex align-items-center bg-white rounded-pill p-2 shadow-sm mb-4">
                        <img src="@(PetModel.ImageUrl ?? "/images/pet-placeholder.png")"
                             class="rounded-circle" width="60" height="60" style="object-fit:cover" />
                        <div class="ms-3">
                            <h5 class="fw-bold mb-0 text-dark">@PetModel.Name</h5>
                            <small class="text-muted">@PetModel.Breed • @PetModel.Age yrs</small>
                        </div>
                    </div>

                    <EditForm Model="Input" OnValidSubmit="SubmitBooking" FormName="book-appointment">
                        <DataAnnotationsValidator />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="ms-3 mb-1 small fw-bold text-muted">Date</label>
                                <div class="input-group-custom">
                                    <i class="bi bi-calendar-event input-icon"></i>
                                    <InputDate @bind-Value="Input.Date" class="form-input" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="ms-3 mb-1 small fw-bold text-muted">Time</label>
                                <div class="input-group-custom">
                                    <i class="bi bi-clock input-icon"></i>
                                    <InputDate Type="InputDateType.Time" @bind-Value="Input.Time" class="form-input" />
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="ms-3 mb-1 small fw-bold text-muted">Message to Shelter</label>
                                <div class="input-group-custom">
                                    <i class="bi bi-chat-text input-icon" style="top: 20px;"></i>
                                    <InputTextArea @bind-Value="Input.Notes" class="form-input" rows="4" placeholder="e.g. I have a large yard and two cats..." />
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            <a href="pet/@PetId" class="btn btn-link text-decoration-none text-muted fw-bold">Cancel</a>
                            <button type="submit" class="liquid-btn flex-grow-1">
                                Confirm Booking
                            </button>
                        </div>
                    </EditForm>
                }
            </div>

        </div>
    </div>
</div>

@code {
    [Parameter] public int PetId { get; set; }

    [SupplyParameterFromForm]
    private BookingInput Input { get; set; } = new();

    private Pet? PetModel;
    private string? UserId;

    protected override async Task OnInitializedAsync()
    {
        // 1. Get User
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        UserId = authState.User.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;

        // 2. Get Pet
        if (PetId > 0)
        {
            PetModel = await PetRepo.GetByIdAsync(PetId);
            if (PetModel == null) Nav.NavigateTo("/pets");
        }

        // 3. Set Default Date (Tomorrow)
        if (Input.Date == default) Input.Date = DateTime.Now.AddDays(1);
    }

    private async Task SubmitBooking()
    {
        if (PetModel != null && UserId != null)
        {
            var appointment = new Appointment
            {
                PetId = PetModel.Id,
                ShelterId = PetModel.ShelterId,
                AdopterUserId = UserId, // Link to current user
                AppointmentDate = Input.Date,
                AppointmentTime = Input.Time.TimeOfDay, // Extract TimeSpan
                Notes = Input.Notes,
                Status = AppointmentStatus.Pending
            };

            await ApptRepo.AddAsync(appointment);
            Nav.NavigateTo("my-appointments");
        }
    }

    public class BookingInput
    {
        [Required]
        public DateTime Date { get; set; }

        [Required]
        public DateTime Time { get; set; } = DateTime.Today.AddHours(10); // Default 10 AM

        [StringLength(500)]
        public string? Notes { get; set; }
    }
}