@page "/shelter/appointments"
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Enums
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider
@inject IAppointmentRepository ApptRepo
@inject IShelterRepository ShelterRepo

@* SECURITY: 
    This page is restricted to users with the 'Shelter' role only.
    Adopters cannot access this dashboard. 
*@
@attribute [Authorize(Roles = "Shelter")]

@* RENDER MODE: InteractiveServer enables real-time event handling via SignalR *@
@rendermode InteractiveServer

<div class="container py-4">
    <div class="text-center mb-5">
        <h3 class="fw-bold">Manage Appointments</h3>
    </div>

    @* TAB NAVIGATION: 
       I use a manual tab system here controlled by the '_activeTab' variable.
       This lets me show two different views (Requests vs Schedule) on one page without reloading.
    *@
    <div class="d-flex justify-content-center mb-5">
        <div class="glass-tabs-container">
            <button class="btn-glass-tab @(_activeTab == "requests" ? "active" : "")"
                    @onclick='() => SwitchTab("requests")'>
                Incoming Requests
                @* NOTIFICATION BADGE: Shows the count of pending items only if there are any *@
                @if (_pending.Any())
                {
                    <span class="badge bg-danger rounded-pill ms-2">@_pending.Count()</span>
                }
            </button>
            <button class="btn-glass-tab @(_activeTab == "schedule" ? "active" : "")"
                    @onclick='() => SwitchTab("schedule")'>
                Scheduled Visits
            </button>
        </div>
    </div>

    @* FEEDBACK UI: Displays errors only if something goes wrong (like a database failure) *@
    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger text-center">@_errorMessage</div>
    }

    @* VIEW 1: INCOMING REQUESTS TAB *@
    @if (_activeTab == "requests")
    {
        @if (!_pending.Any())
        {
            <div class="text-center text-muted py-5">No pending requests.</div>
        }
        else
        {
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    @foreach (var appt in _pending)
                    {
                        <div class="glass-card mb-3 p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="fw-bold mb-1 text-primary">Request for @appt.Pet?.Name</h5>
                                    <div class="text-muted small">
                                        @* NULL CHECK: Uses '??' to display a fallback if the User object is missing *@
                                        Adopter: <strong>@(appt.AdopterUser?.FullName ?? "Unknown User")</strong>
                                    </div>
                                    @if (!string.IsNullOrEmpty(appt.Notes))
                                    {
                                        <p class="mt-2 mb-0 fst-italic text-muted">"@appt.Notes"</p>
                                    }
                                </div>
                                <span class="badge bg-warning text-dark">Pending</span>
                            </div>

                            @* INTERACTIVE FORM: 
                               Allows the Shelter to override the proposed time before confirming.
                               @bind syncs the input directly to the appointment object.
                            *@
                            <div class="bg-white rounded-3 p-3 mb-3 border">
                                <label class="small fw-bold text-muted mb-2">Set Appointment Time:</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="date" class="form-control form-control-sm" @bind="appt.AppointmentDate" />
                                    </div>
                                    <div class="col-6">
                                        @* TIME BINDING: 
                                           Time inputs return strings (e.g. "14:30"), but C# uses TimeSpan.
                                           I use 'UpdateTime' to handle this conversion manually.
                                        *@
                                        <input type="time" class="form-control form-control-sm"
                                               value="@appt.AppointmentTime.ToString(@"hh\:mm")"
                                               @onchange="@(e => UpdateTime(appt, e.Value))" />
                                    </div>
                                </div>
                            </div>

                            @* ACTION BUTTONS: 
                               Calls UpdateStatus to move the item from 'Pending' to 'Confirmed' or 'Denied' 
                            *@
                            <div class="d-flex gap-2 justify-content-end">
                                <button class="btn btn-outline-danger btn-sm rounded-pill px-4"
                                        @onclick="() => UpdateStatus(appt, AppointmentStatus.Denied)">
                                    Deny
                                </button>
                                <button class="btn btn-success btn-sm rounded-pill px-4"
                                        @onclick="() => UpdateStatus(appt, AppointmentStatus.Confirmed)">
                                    Confirm & Schedule
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }

    @* VIEW 2: SCHEDULED VISITS TAB *@
    @if (_activeTab == "schedule")
    {
        @if (!_scheduled.Any())
        {
            <div class="text-center text-muted py-5">No upcoming visits.</div>
        }
        else
        {
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    @foreach (var appt in _scheduled)
                    {
                        <div class="glass-card mb-3 p-4 border-start border-5 border-success">

                            @* INLINE EDITING LOGIC: 
                               If '_editingId' matches this card, show the edit form.
                               Otherwise, show the read-only view. This avoids opening a separate page.
                            *@
                            @if (_editingId == appt.Id)
                            {
                                <h5 class="fw-bold mb-3 text-primary">Edit Appointment</h5>
                                <div class="mb-3">
                                    <label class="small fw-bold text-muted">Date</label>
                                    <input type="date" class="form-control" @bind="appt.AppointmentDate" />
                                </div>
                                <div class="mb-3">
                                    <label class="small fw-bold text-muted">Time</label>
                                    <input type="time" class="form-control"
                                           value="@appt.AppointmentTime.ToString(@"hh\:mm")"
                                           @onchange="@(e => UpdateTime(appt, e.Value))" />
                                </div>
                                <div class="d-flex justify-content-end gap-2 mt-3">
                                    <button class="btn btn-secondary btn-sm rounded-pill" @onclick="() => _editingId = 0">Cancel</button>
                                    <button class="btn btn-primary btn-sm rounded-pill" @onclick="() => SaveEdit(appt)">Save Changes</button>
                                </div>
                            }
                            else
                            {
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="fw-bold mb-1">Visit for @appt.Pet?.Name</h5>
                                        <div class="text-muted small">
                                            <i class="bi bi-calendar-check text-success"></i>
                                            @appt.AppointmentDate.ToString("D") at @appt.AppointmentTime.ToString(@"hh\:mm")
                                        </div>
                                        <div class="mt-1 small">
                                            With: <strong>@(appt.AdopterUser?.FullName ?? "Unknown User")</strong>
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center gap-2">
                                        <button class="btn btn-outline-primary btn-sm rounded-circle"
                                                title="Edit Details"
                                                @onclick="() => _editingId = appt.Id">
                                            <i class="bi bi-pencil"></i>
                                        </button>

                                        <button class="btn btn-outline-danger btn-sm rounded-circle"
                                                title="Cancel Appointment"
                                                @onclick="() => DeleteAppointment(appt.Id)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    // STATE MANAGEMENT:
    // _activeTab: Controls which view is visible (Requests vs Schedule)
    // _editingId: Tracks which specific appointment is currently being edited inline
    private string _activeTab = "requests";
    private int _editingId = 0;
    private string _errorMessage = "";

    // DATA BUCKETS:
    // We fetch all data once, then split it into these two lists for display.
    private IEnumerable<Appointment> _pending = new List<Appointment>();
    private IEnumerable<Appointment> _scheduled = new List<Appointment>();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private void SwitchTab(string tab)
    {
        _activeTab = tab;
        _editingId = 0; // UX Improvement: Close any open edit forms when switching tabs to prevent confusion.
        _errorMessage = "";
    }

    // CENTRALIZED DATA LOADING
    private async Task LoadData()
    {
        try
        {
            // 1. Identify the current Shelter User
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;

            // 2. Find the Shelter profile associated with this login
            var shelters = await ShelterRepo.GetAllAsync();
            var myShelter = shelters.FirstOrDefault(s => s.OwnerUserId == userId);

            if (myShelter != null)
            {
                // 3. TENANCY FILTER: Only fetch appointments for THIS shelter's ID.
                var all = await ApptRepo.GetByShelterIdAsync(myShelter.Id);

                // 4. IN-MEMORY SORTING:
                // We split the single list into "Pending" and "Confirmed" so we can render them in different tabs.
                _pending = all.Where(a => a.Status == AppointmentStatus.Pending).OrderBy(a => a.AppointmentDate).ToList();
                _scheduled = all.Where(a => a.Status == AppointmentStatus.Confirmed).OrderBy(a => a.AppointmentDate).ToList();
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "Error loading data. Please refresh.";
            Console.WriteLine(ex.Message);
        }
    }

    // HELPER: Time Parsing
    // HTML time inputs return a string, but our database needs a TimeSpan object.
    private void UpdateTime(Appointment appt, object? value)
    {
        if (TimeSpan.TryParse(value?.ToString(), out var time))
        {
            appt.AppointmentTime = time;
        }
    }

    // WORKFLOW LOGIC:
    // This handles the transition of an appointment's lifecycle (e.g. Pending -> Confirmed).
    private async Task UpdateStatus(Appointment appt, AppointmentStatus status)
    {
        try
        {
            appt.Status = status;
            await ApptRepo.UpdateAsync(appt); // Save to SQL
            await LoadData(); // Refresh the list to move the item to the correct tab
        }
        catch { _errorMessage = "Failed to update status."; }
    }

    private async Task SaveEdit(Appointment appt)
    {
        try
        {
            await ApptRepo.UpdateAsync(appt);
            _editingId = 0; // Close the inline editor
            await LoadData();
        }
        catch { _errorMessage = "Failed to save changes."; }
    }

    private async Task DeleteAppointment(int id)
    {
        try
        {
            await ApptRepo.DeleteAsync(id);
            await LoadData();
        }
        catch { _errorMessage = "Failed to delete appointment."; }
    }
}