@page "/shelter/appointments"
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Enums
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider
@inject IAppointmentRepository ApptRepo
@inject IShelterRepository ShelterRepo
@attribute [Authorize(Roles = "Shelter")]

@* RENDER MODE: InteractiveServer enables real-time event handling via SignalR *@
@rendermode InteractiveServer

<div class="container py-4">
    <div class="text-center mb-5">
        <h3 class="fw-bold">Manage Appointments</h3>
    </div>

    @* TAB NAVIGATION: Toggles internal state variable '_activeTab' *@
    <div class="d-flex justify-content-center mb-5">
        <div class="glass-tabs-container">
            <button class="btn-glass-tab @(_activeTab == "requests" ? "active" : "")"
                    @onclick='() => SwitchTab("requests")'>
                Incoming Requests
                @if (_pending.Any())
                {
                    <span class="badge bg-danger rounded-pill ms-2">@_pending.Count()</span>
                }
            </button>
            <button class="btn-glass-tab @(_activeTab == "schedule" ? "active" : "")"
                    @onclick='() => SwitchTab("schedule")'>
                Scheduled Visits
            </button>
        </div>
    </div>

    @* ERROR HANDLING: Feedback display *@
    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger text-center">@_errorMessage</div>
    }

    @* CONDITIONAL RENDERING: View Logic for "Requests" Tab *@
    @if (_activeTab == "requests")
    {
        @if (!_pending.Any())
        {
            <div class="text-center text-muted py-5">No pending requests.</div>
        }
        else
        {
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    @foreach (var appt in _pending)
                    {
                        <div class="glass-card mb-3 p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="fw-bold mb-1 text-primary">Request for @appt.Pet?.Name</h5>
                                    <div class="text-muted small">
                                        Adopter: <strong>@(appt.AdopterUser?.FullName ?? "Unknown User")</strong>
                                    </div>
                                    @if (!string.IsNullOrEmpty(appt.Notes))
                                    {
                                        <p class="mt-2 mb-0 fst-italic text-muted">"@appt.Notes"</p>
                                    }
                                </div>
                                <span class="badge bg-warning text-dark">Pending</span>
                            </div>

                            @* INTERACTIVE FORM: Allows Shelter to set date/time before confirming *@
                            <div class="bg-white rounded-3 p-3 mb-3 border">
                                <label class="small fw-bold text-muted mb-2">Set Appointment Time:</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="date" class="form-control form-control-sm" @bind="appt.AppointmentDate" />
                                    </div>
                                    <div class="col-6">
                                        <input type="time" class="form-control form-control-sm"
                                               value="@appt.AppointmentTime.ToString(@"hh\:mm")"
                                               @onchange="@(e => UpdateTime(appt, e.Value))" />
                                    </div>
                                </div>
                            </div>

                            @* ACTION BUTTONS: Trigger State Transitions (Pending -> Denied/Confirmed) *@
                            <div class="d-flex gap-2 justify-content-end">
                                <button class="btn btn-outline-danger btn-sm rounded-pill px-4"
                                        @onclick="() => UpdateStatus(appt, AppointmentStatus.Denied)">
                                    Deny
                                </button>
                                <button class="btn btn-success btn-sm rounded-pill px-4"
                                        @onclick="() => UpdateStatus(appt, AppointmentStatus.Confirmed)">
                                    Confirm & Schedule
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }

    @* CONDITIONAL RENDERING: View Logic for "Schedule" Tab *@
    @if (_activeTab == "schedule")
    {
        @if (!_scheduled.Any())
        {
            <div class="text-center text-muted py-5">No upcoming visits.</div>
        }
        else
        {
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    @foreach (var appt in _scheduled)
                    {
                        <div class="glass-card mb-3 p-4 border-start border-5 border-success">

                            @* INLINE EDITING: Conditional rendering based on '_editingId' *@
                            @if (_editingId == appt.Id)
                            {
                                <h5 class="fw-bold mb-3 text-primary">Edit Appointment</h5>
                                <div class="mb-3">
                                    <label class="small fw-bold text-muted">Date</label>
                                    <input type="date" class="form-control" @bind="appt.AppointmentDate" />
                                </div>
                                <div class="mb-3">
                                    <label class="small fw-bold text-muted">Time</label>
                                    <input type="time" class="form-control"
                                           value="@appt.AppointmentTime.ToString(@"hh\:mm")"
                                           @onchange="@(e => UpdateTime(appt, e.Value))" />
                                </div>
                                <div class="d-flex justify-content-end gap-2 mt-3">
                                    <button class="btn btn-secondary btn-sm rounded-pill" @onclick="() => _editingId = 0">Cancel</button>
                                    <button class="btn btn-primary btn-sm rounded-pill" @onclick="() => SaveEdit(appt)">Save Changes</button>
                                </div>
                            }
                            else
                            {
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="fw-bold mb-1">Visit for @appt.Pet?.Name</h5>
                                        <div class="text-muted small">
                                            <i class="bi bi-calendar-check text-success"></i>
                                            @appt.AppointmentDate.ToString("D") at @appt.AppointmentTime.ToString(@"hh\:mm")
                                        </div>
                                        <div class="mt-1 small">
                                            With: <strong>@(appt.AdopterUser?.FullName ?? "Unknown User")</strong>
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center gap-2">
                                        <button class="btn btn-outline-primary btn-sm rounded-circle"
                                                title="Edit Details"
                                                @onclick="() => _editingId = appt.Id">
                                            <i class="bi bi-pencil"></i>
                                        </button>

                                        <button class="btn btn-outline-danger btn-sm rounded-circle"
                                                title="Cancel Appointment"
                                                @onclick="() => DeleteAppointment(appt.Id)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    // UI State Controls
    private string _activeTab = "requests";
    private int _editingId = 0;
    private string _errorMessage = "";

    // Data Collections
    private IEnumerable<Appointment> _pending = new List<Appointment>();
    private IEnumerable<Appointment> _scheduled = new List<Appointment>();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private void SwitchTab(string tab)
    {
        _activeTab = tab;
        _editingId = 0; // UX: Reset editing state when navigating away
        _errorMessage = "";
    }

    // CENTRALIZED DATA LOADING
    private async Task LoadData()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;

            var shelters = await ShelterRepo.GetAllAsync();
            var myShelter = shelters.FirstOrDefault(s => s.OwnerUserId == userId);

            if (myShelter != null)
            {
                // DATA ACCESS: Fetch all records associated with this tenant (Shelter)
                var all = await ApptRepo.GetByShelterIdAsync(myShelter.Id);

                // IN-MEMORY FILTERING: Segregate data into buckets based on Status Enum
                _pending = all.Where(a => a.Status == AppointmentStatus.Pending).OrderBy(a => a.AppointmentDate).ToList();
                _scheduled = all.Where(a => a.Status == AppointmentStatus.Confirmed).OrderBy(a => a.AppointmentDate).ToList();
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "Error loading data. Please refresh.";
            Console.WriteLine(ex.Message);
        }
    }

    // UTILITY: Safe Parsing for TimeSpan
    private void UpdateTime(Appointment appt, object? value)
    {
        if (TimeSpan.TryParse(value?.ToString(), out var time))
        {
            appt.AppointmentTime = time;
        }
    }

    // LOGIC: State Transition (Pending -> Confirmed/Denied)
    private async Task UpdateStatus(Appointment appt, AppointmentStatus status)
    {
        try
        {
            appt.Status = status;
            await ApptRepo.UpdateAsync(appt); // DB Commit
            await LoadData(); // UI Refresh
        }
        catch { _errorMessage = "Failed to update status."; }
    }

    private async Task SaveEdit(Appointment appt)
    {
        try
        {
            await ApptRepo.UpdateAsync(appt);
            _editingId = 0;
            await LoadData();
        }
        catch { _errorMessage = "Failed to save changes."; }
    }

    private async Task DeleteAppointment(int id)
    {
        try
        {
            await ApptRepo.DeleteAsync(id);
            await LoadData();
        }
        catch { _errorMessage = "Failed to delete appointment."; }
    }
}