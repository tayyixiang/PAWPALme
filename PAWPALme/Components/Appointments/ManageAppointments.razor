@page "/shelter/appointments"
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Enums
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider
@inject IAppointmentRepository ApptRepo
@inject IShelterRepository ShelterRepo
@attribute [Authorize(Roles = "Shelter")]
@rendermode InteractiveServer

<div class="container py-4">
    <div class="text-center mb-5">
        <h3 class="fw-bold">Manage Appointments</h3>
        <p class="text-muted">Review incoming requests and upcoming visits.</p>
    </div>

    <div class="d-flex justify-content-center mb-5">
        <div class="glass-tabs-container">
            <button class="btn-glass-tab @(_activeTab == "requests" ? "active" : "")"
                    @onclick='() => _activeTab = "requests"'>
                Incoming Requests
                @if (_pending.Any())
                {
                    <span class="badge bg-danger rounded-pill ms-2">@_pending.Count()</span>
                }
            </button>
            <button class="btn-glass-tab @(_activeTab == "schedule" ? "active" : "")"
                    @onclick='() => _activeTab = "schedule"'>
                Scheduled Visits
            </button>
        </div>
    </div>

    @if (_activeTab == "requests")
    {
        @if (!_pending.Any())
        {
            <div class="text-center text-muted py-5">
                <i class="bi bi-inbox fs-1 d-block mb-3 opacity-50"></i>
                No pending requests at the moment.
            </div>
        }
        else
        {
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    @foreach (var appt in _pending)
                    {
                        <div class="glass-card mb-3 p-4">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                                <div>
                                    <h5 class="fw-bold mb-1 text-primary">Request for @appt.Pet?.Name</h5>
                                    <div class="d-flex align-items-center gap-2 text-muted small">
                                        <i class="bi bi-calendar"></i> @appt.AppointmentDate.ToString("D")
                                        <i class="bi bi-clock ms-2"></i> @appt.AppointmentTime.ToString()
                                    </div>
                                    @* FIX: Changed Comments to Notes *@
                                    @if (!string.IsNullOrEmpty(appt.Notes))
                                    {
                                        <p class="mt-2 mb-0 text-dark fst-italic">"@appt.Notes"</p>
                                    }
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success rounded-pill px-4 shadow-sm"
                                            @onclick="() => UpdateStatus(appt, AppointmentStatus.Confirmed)">
                                        <i class="bi bi-check-lg me-1"></i> Accept
                                    </button>
                                    <button class="btn btn-outline-danger rounded-pill px-4"
                                            @onclick="() => UpdateStatus(appt, AppointmentStatus.Denied)">
                                        Deny
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }

    @if (_activeTab == "schedule")
    {
        @if (!_scheduled.Any())
        {
            <div class="text-center text-muted py-5">
                <i class="bi bi-calendar-x fs-1 d-block mb-3 opacity-50"></i>
                No upcoming visits scheduled.
            </div>
        }
        else
        {
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    @foreach (var appt in _scheduled)
                    {
                        <div class="glass-card mb-3 p-4 border-start border-5 border-success">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="fw-bold mb-1">Visit for @appt.Pet?.Name</h5>
                                    <div class="d-flex align-items-center gap-2 text-muted small">
                                        <i class="bi bi-calendar-check text-success"></i> @appt.AppointmentDate.ToString("D") at @appt.AppointmentTime.ToString()
                                    </div>
                                    <div class="mt-2 small text-muted">
                                        @* FIX: Changed Adopter to AdopterUser *@
                                        Adopter: <span class="fw-bold text-dark">@(appt.AdopterUser?.FullName ?? "Unknown")</span>
                                    </div>
                                </div>
                                <span class="badge bg-success rounded-pill px-3 py-2">Confirmed</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    private string _activeTab = "requests";
    private IEnumerable<Appointment> _pending = new List<Appointment>();
    private IEnumerable<Appointment> _scheduled = new List<Appointment>();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;

        var shelters = await ShelterRepo.GetAllAsync();
        var myShelter = shelters.FirstOrDefault(s => s.OwnerUserId == userId);

        if (myShelter != null)
        {
            var all = await ApptRepo.GetByShelterIdAsync(myShelter.Id);

            _pending = all.Where(a => a.Status == AppointmentStatus.Pending).OrderBy(a => a.AppointmentDate).ToList();
            _scheduled = all.Where(a => a.Status == AppointmentStatus.Confirmed).OrderBy(a => a.AppointmentDate).ToList();
        }
    }

    private async Task UpdateStatus(Appointment appt, AppointmentStatus status)
    {
        appt.Status = status;
        await ApptRepo.UpdateAsync(appt);
        await LoadData();
    }
}