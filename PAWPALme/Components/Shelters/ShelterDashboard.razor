@page "/shelter/dashboard"
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Enums

@* ARCHITECTURE: Dependency Injection (DI) 
   We inject multiple repositories because a Dashboard needs to see everything:
   - Who am I? (AuthState)
   - Who is my Shelter? (ShelterRepo)
   - How many pets do I have? (PetRepo)
   - Do I have appointments? (ApptRepo)
*@
@inject AuthenticationStateProvider AuthStateProvider
@inject IShelterRepository ShelterRepo
@inject IPetRepository PetRepo
@inject IAppointmentRepository ApptRepo
@inject NavigationManager Nav



@* SECURITY: 
   The [Authorize] attribute acts as a firewall. 
   Only users with the specific "Shelter" role can load this page.
*@
@attribute [Authorize(Roles = "Shelter")]

<PageTitle>Shelter Command | PawPal</PageTitle>

<div class="container py-5">

    @* STATE MANAGEMENT: 
       Dashboards load data from many places, so they take a moment.
       We show a spinner (_isLoading) to prevent the user from seeing a "glitchy" empty page.
    *@
    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-3 text-muted">Loading command center...</p>
        </div>
    }
    @* ERROR STATE: If the user has the 'Shelter' role but no profile in the DB *@
    else if (_myShelter == null)
    {
        <div class="alert alert-warning text-center rounded-pill">
            <i class="bi bi-exclamation-triangle me-2"></i> No Shelter Found
        </div>
    }
    else
    {
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bold text-dark mb-2">
                @_myShelter.Name
            </h1>
            <p class="text-muted text-uppercase ls-2 small fw-bold">Command Center</p>
        </div>

        @* DASHBOARD METRICS:
           These numbers aren't hardcoded. They are calculated live in 'OnInitializedAsync'.
        *@
        <div class="row g-4 mb-5 justify-content-center">
            <div class="col-md-4 col-lg-3">
                <div class="glass-stat-card text-center">
                    <h2 class="fw-bold text-primary mb-0">@_petCount</h2>
                    <small class="text-muted fw-bold">Active Pets</small>
                </div>
            </div>
            <div class="col-md-4 col-lg-3">
                <div class="glass-stat-card text-center">
                    <h2 class="fw-bold text-purple mb-0">@_pendingAppts</h2>
                    <small class="text-muted fw-bold">Requests</small>
                </div>
            </div>
            <div class="col-md-4 col-lg-3">
                <div class="glass-stat-card text-center">
                    <h2 class="fw-bold text-success mb-0">@_confirmedAppts</h2>
                    <small class="text-muted fw-bold">Visits Scheduled</small>
                </div>
            </div>
        </div>

        @* NAVIGATION HUB: 
           Quick links to the main subsystems (Pets, Appointments, Settings).
        *@
        <div class="d-flex justify-content-center">
            <div class="glass-tabs-container">
                <a href="shelter/pets" class="btn-glass-tab text-decoration-none">
                    <i class="bi bi-folder-plus me-2"></i>Manage Pets
                </a>
                <a href="shelter/appointments" class="btn-glass-tab text-decoration-none">
                    <i class="bi bi-calendar-week me-2"></i>Appointments
                </a>
                <a href="shelter/settings" class="btn-glass-tab text-decoration-none">
                    <i class="bi bi-gear me-2"></i>Settings
                </a>
            </div>
        </div>
    }
</div>

@code {
    // UI STATE: Controls the loading spinner
    private bool _isLoading = true;

    // DATA MODEL: Stores the current shelter's profile
    private Shelter? _myShelter;

    // METRICS: Variables to hold the counted stats
    private int _petCount = 0;
    private int _pendingAppts = 0;
    private int _confirmedAppts = 0;



    // LIFECYCLE: This runs immediately when the page opens.
    protected override async Task OnInitializedAsync()
    {
        // 1. IDENTIFY USER: "Who is logged in right now?"
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            // 2. GET ID: Extract the user's SQL ID
            var userId = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;

            // 3. RESOLVE TENANT: "Which Shelter matches this User ID?"
            var allShelters = await ShelterRepo.GetAllAsync();
            _myShelter = allShelters.FirstOrDefault(s => s.OwnerUserId == userId);

            if (_myShelter != null)
            {
                // 4. AGGREGATE DATA:
                // We fetch all data and filter it in memory to generate the dashboard numbers.

                // Count Pets
                var allPets = await PetRepo.GetAllAsync();
                _petCount = allPets.Count(p => p.ShelterId == _myShelter.Id);

                // Count Appointments (Split by Status)
                var myAppts = await ApptRepo.GetByShelterIdAsync(_myShelter.Id);
                _pendingAppts = myAppts.Count(a => a.Status == AppointmentStatus.Pending);
                _confirmedAppts = myAppts.Count(a => a.Status == AppointmentStatus.Confirmed);
            }
        }

        // 5. UPDATE UI: Turn off the spinner and show the dashboard
        _isLoading = false;
    }
}