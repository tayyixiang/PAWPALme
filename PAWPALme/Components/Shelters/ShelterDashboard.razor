@page "/shelter/dashboard"
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Enums

@* ARCHITECTURE: Dependency Injection (DI) *@
@* Injecting abstraction layers (Repositories) allows for loose coupling and easier testing. *@
@inject AuthenticationStateProvider AuthStateProvider
@inject IShelterRepository ShelterRepo
@inject IPetRepository PetRepo
@inject IAppointmentRepository ApptRepo
@inject NavigationManager Nav

@* SECURITY: Role-Based Access Control (RBAC) *@
@* Restricts execution of this page strictly to users with the 'Shelter' claim. *@
@attribute [Authorize(Roles = "Shelter")]

<PageTitle>Shelter Command | PawPal</PageTitle>

<div class="container py-5">

    @* UX STATE: Conditional Rendering handles the async data loading latency *@
    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-3 text-muted">Loading command center...</p>
        </div>
    }
    else if (_myShelter == null)
    {
        <div class="alert alert-warning text-center rounded-pill">
            <i class="bi bi-exclamation-triangle me-2"></i> No Shelter Found
        </div>
    }
    else
    {
        <div class="text-center mb-5">
            @* DATA BINDING: One-way binding from the C# model to the DOM *@
            <h1 class="display-5 fw-bold text-dark mb-2">
                @_myShelter.Name
            </h1>
            <p class="text-muted text-uppercase ls-2 small fw-bold">Command Center</p>
        </div>

        <div class="row g-4 mb-5 justify-content-center">
            @* METRICS: Displaying aggregated stats calculated in OnInitializedAsync *@
            <div class="col-md-4 col-lg-3">
                <div class="glass-stat-card text-center">
                    <h2 class="fw-bold text-primary mb-0">@_petCount</h2>
                    <small class="text-muted fw-bold">Active Pets</small>
                </div>
            </div>
            <div class="col-md-4 col-lg-3">
                <div class="glass-stat-card text-center">
                    <h2 class="fw-bold text-purple mb-0">@_pendingAppts</h2>
                    <small class="text-muted fw-bold">Requests</small>
                </div>
            </div>
            <div class="col-md-4 col-lg-3">
                <div class="glass-stat-card text-center">
                    <h2 class="fw-bold text-success mb-0">@_confirmedAppts</h2>
                    <small class="text-muted fw-bold">Visits Scheduled</small>
                </div>
            </div>
        </div>

        @* NAVIGATION: Static routing to functional subsystems *@
        <div class="d-flex justify-content-center">
            <div class="glass-tabs-container">
                <a href="shelter/pets" class="btn-glass-tab text-decoration-none">
                    <i class="bi bi-folder-plus me-2"></i>Manage Pets
                </a>
                <a href="shelter/appointments" class="btn-glass-tab text-decoration-none">
                    <i class="bi bi-calendar-week me-2"></i>Appointments
                </a>
                <a href="shelter/settings" class="btn-glass-tab text-decoration-none">
                    <i class="bi bi-gear me-2"></i>Settings
                </a>
            </div>
        </div>
    }
</div>

@code {
    // State Management: Private fields control component state and data storage
    private bool _isLoading = true;
    private Shelter? _myShelter;

    // Aggregated Metrics
    private int _petCount = 0;
    private int _pendingAppts = 0;
    private int _confirmedAppts = 0;

    // LIFECYCLE METHOD: Executed once when the component is ready to start
    protected override async Task OnInitializedAsync()
    {
        // 1. Identity Resolution: Access the current User Context from the secure HttpContext
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            // 2. Claim Extraction: Retrieve the unique NameIdentifier (Primary Key) of the logged-in user
            var userId = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;

            // 3. Data Fetching: Retrieve all shelters to perform owner matching
            var allShelters = await ShelterRepo.GetAllAsync();
            _myShelter = allShelters.FirstOrDefault(s => s.OwnerUserId == userId);

            if (_myShelter != null)
            {
                // 4. Aggregation Logic: Execute parallel queries to build dashboard stats
                var allPets = await PetRepo.GetAllAsync();
                // LINQ Query: Filtering pets belonging to this specific tenant (Shelter)
                _petCount = allPets.Count(p => p.ShelterId == _myShelter.Id);

                var myAppts = await ApptRepo.GetByShelterIdAsync(_myShelter.Id);
                // LINQ Projection: Categorizing appointments by status Enum
                _pendingAppts = myAppts.Count(a => a.Status == AppointmentStatus.Pending);
                _confirmedAppts = myAppts.Count(a => a.Status == AppointmentStatus.Confirmed);
            }
        }

        // 5. Render Trigger: Updating state variable forces the Blazor renderer to refresh the UI
        _isLoading = false;
    }
}