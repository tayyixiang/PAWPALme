@page "/shelter/register"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using PAWPALme.Data
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Components.Account
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject RoleManager<IdentityRole> RoleManager
@inject IShelterRepository ShelterRepo
@inject NavigationManager Nav
@inject IdentityUserAccessor UserAccessor

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">Shelter Registration</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">Create an account to manage your shelter and list pets.</p>

                    <EditForm Model="Input" OnValidSubmit="RegisterShelter" FormName="shelter-register">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger mb-3" />

                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="border-bottom pb-2">1. Account Login</h5>
                                <div class="mb-3">
                                    <label class="form-label">Email Address</label>
                                    <InputText @bind-Value="Input.Email" class="form-control" placeholder="name@example.com" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Password</label>
                                    <InputText @bind-Value="Input.Password" type="password" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Confirm Password</label>
                                    <InputText @bind-Value="Input.ConfirmPassword" type="password" class="form-control" />
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5 class="border-bottom pb-2">2. Shelter Details</h5>
                                <div class="mb-3">
                                    <label class="form-label">Shelter Name</label>
                                    <InputText @bind-Value="Input.ShelterName" class="form-control" placeholder="e.g. Happy Paws" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Address</label>
                                    <InputText @bind-Value="Input.Address" class="form-control" placeholder="Full Address" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Phone Number</label>
                                    <InputText @bind-Value="Input.Phone" class="form-control" placeholder="Office Phone" />
                                </div>
                            </div>
                        </div>

                        <hr />

                        <div class="d-flex justify-content-end">
                            <a href="/" class="btn btn-secondary me-2">Cancel</a>
                            <button type="submit" class="btn btn-primary px-4">Register Shelter</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private RegisterInputModel Input { get; set; } = new();

    public async Task RegisterShelter()
    {
        // 1. Ensure "Shelter" Role Exists
        if (!await RoleManager.RoleExistsAsync("Shelter"))
        {
            await RoleManager.CreateAsync(new IdentityRole("Shelter"));
        }

        // 2. Create the User Account
        var user = new ApplicationUser { UserName = Input.Email, Email = Input.Email };
        var result = await UserManager.CreateAsync(user, Input.Password);

        if (result.Succeeded)
        {
            // 3. Assign Role
            await UserManager.AddToRoleAsync(user, "Shelter");

            // 4. Create Shelter Entity
            var shelter = new Shelter
            {
                Name = Input.ShelterName,
                Address = Input.Address,
                Phone = Input.Phone,
                OwnerUserId = user.Id
            };
            await ShelterRepo.AddAsync(shelter);

            // 5. Link User to Shelter
            user.ShelterId = shelter.Id;
            await UserManager.UpdateAsync(user);

            // 6. Auto Sign-In
            await SignInManager.SignInAsync(user, isPersistent: false);
            Nav.NavigateTo("/shelter/dashboard");
        }
        else
        {
            // Handle Identity Errors (Password too weak, etc.)
            foreach (var error in result.Errors)
            {
                Console.WriteLine($"Error: {error.Description}");
            }
        }
    }

    public class RegisterInputModel
    {
        [Required, EmailAddress]
        public string Email { get; set; } = "";

        [Required, StringLength(100, MinimumLength = 6)]
        public string Password { get; set; } = "";

        [Compare("Password", ErrorMessage = "Passwords do not match.")]
        public string ConfirmPassword { get; set; } = "";

        [Required]
        public string ShelterName { get; set; } = "";

        [Required]
        public string Address { get; set; } = "";

        [Required]
        public string Phone { get; set; } = "";
    }
}
