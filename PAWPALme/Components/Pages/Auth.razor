@page "/auth"
@rendermode InteractiveServer
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using PAWPALme.Data
@using PAWPALme.Models
@using PAWPALme.Services
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav
@inject ShelterService ShelterService

<PageTitle>Login / Sign up</PageTitle>

<style>
    .pp-gradient-bg {
        background: linear-gradient(135deg, #e0e7ff 0%, #fce7f3 100%);
        min-height: 100vh;
    }

    .pp-card {
        border-radius: 1.25rem;
        box-shadow: 0 20px 50px rgba(0,0,0,.12);
    }

    .pp-pill {
        border-radius: 999px;
    }

    .pp-btn-gradient {
        background: linear-gradient(to right, #4f46e5, #9333ea);
        border: none;
    }

        .pp-btn-gradient:hover {
            background: linear-gradient(to right, #4338ca, #7e22ce);
        }
</style>

<div class="pp-gradient-bg d-flex align-items-center justify-content-center p-3">
    <div style="width: 100%; max-width: 460px;">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="btn-group" role="group">
                <button type="button"
                        class="btn pp-pill @(authType == AuthType.Adopter ? "btn-primary" : "btn-light") fw-semibold"
                        @onclick="() => SetAuthType(AuthType.Adopter)">
                    Adopter
                </button>
                <button type="button"
                        class="btn pp-pill @(authType == AuthType.Shelter ? "btn-primary" : "btn-light") fw-semibold"
                        @onclick="() => SetAuthType(AuthType.Shelter)">
                    Shelter
                </button>
            </div>

            <button type="button"
                    class="btn btn-outline-danger pp-pill fw-semibold"
                    @onclick="EnableAdminLogin">
                Admin
            </button>
        </div>

        <div class="bg-white p-4 p-md-5 pp-card">
            <div class="text-center mb-4">
                <h1 class="h3 fw-bold mb-1">@HeaderTitle</h1>
                <div class="text-muted">@HeaderSubtitle</div>
            </div>

            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <div class="alert alert-danger py-2">@errorMessage</div>
            }

            <EditForm Model="form" OnValidSubmit="HandleSubmit" method="post" FormName="auth">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <InputText class="form-control" @bind-Value="form.Email" placeholder="user@example.com" />
                </div>

                @if (!isLoginMode && !isAdminMode)
                {
                    @if (authType == AuthType.Adopter)
                    {
                        <div class="mb-3">
                            <label class="form-label">Adopter Name</label>
                            <InputText class="form-control" @bind-Value="form.AdopterName" placeholder="John Doe" />
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label class="form-label">Shelter Name</label>
                            <InputText class="form-control" @bind-Value="form.ShelterName" placeholder="Happy Tails Shelter" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <InputText class="form-control" @bind-Value="form.ShelterAddress" placeholder="123 Street, Singapore" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <InputText class="form-control" @bind-Value="form.ShelterPhone" placeholder="+65 9123 4567" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <InputTextArea class="form-control" @bind-Value="form.ShelterDescription" rows="3"
                                           placeholder="Short description about your shelter..." />
                        </div>
                    }
                }

                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <div class="input-group">
                        <InputText class="form-control"
                                   type="@(showPassword ? "text" : "password")"
                                   @bind-Value="form.Password" />
                        <button type="button" class="btn btn-outline-secondary" @onclick="TogglePassword">
                            @(showPassword ? "Hide" : "Show")
                        </button>
                    </div>
                </div>

                @if (!isLoginMode && !isAdminMode)
                {
                    <div class="mb-3">
                        <label class="form-label">Confirm Password</label>
                        <InputText class="form-control"
                                   type="@(showPassword ? "text" : "password")"
                                   @bind-Value="form.ConfirmPassword" />
                    </div>
                }

                <button type="submit"
                        class="btn w-100 py-2 fw-semibold text-white @(isAdminMode ? "btn-danger" : "pp-btn-gradient")">
                    @(isLoginMode ? "Sign In" : "Create Account")
                </button>
            </EditForm>

            <div class="mt-3 d-flex justify-content-between align-items-center">
                @if (!isAdminMode)
                {
                    <button type="button" class="btn btn-link p-0" @onclick="ToggleMode">
                        @(isLoginMode ? "Don't have an account? Sign up" : "Already have an account? Sign in")
                    </button>
                }
                else
                {
                    <span class="text-muted small">Admin login only</span>
                }

                @if (isLoginMode)
                {
                    <a class="btn btn-link p-0" href="/Account/ForgotPassword">Forgot password?</a>
                }
            </div>
        </div>

    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    private string? returnUrl { get; set; }

    private bool isLoginMode = true;
    private bool isAdminMode = false;
    private bool showPassword = false;

    private string? errorMessage;

    private AuthType authType = AuthType.Adopter;
    private AuthForm form = new();

    private string HeaderTitle =>
        isAdminMode ? "Admin Access" : (authType == AuthType.Shelter ? "Shelter Portal" : "Welcome");

    private string HeaderSubtitle =>
        isLoginMode ? "Sign in to your account" : "Create a new account";

    private void SetAuthType(AuthType type)
    {
        authType = type;
        isAdminMode = false;
        errorMessage = null;
        form = new AuthForm();
    }

    private void EnableAdminLogin()
    {
        isAdminMode = true;
        isLoginMode = true;
        errorMessage = null;
    }

    private void ToggleMode()
    {
        isLoginMode = !isLoginMode;
        errorMessage = null;
        form = new AuthForm();
    }

    private void TogglePassword() => showPassword = !showPassword;

    private async Task HandleSubmit()
    {
        errorMessage = null;

        if (isLoginMode) await HandleLogin();
        else await HandleRegister();
    }

    private async Task HandleLogin()
    {
        if (string.IsNullOrWhiteSpace(form.Email))
        {
            errorMessage = "Email is required.";
            return;
        }

        var user = await UserManager.FindByEmailAsync(form.Email.Trim());
        if (user is null)
        {
            errorMessage = "Account not found.";
            return;
        }

        if (isAdminMode)
        {
            if (!await UserManager.IsInRoleAsync(user, "Admin"))
            {
                errorMessage = "This account is not an admin account.";
                return;
            }
        }
        else
        {
            var requiredRole = authType == AuthType.Shelter ? "Shelter" : "Adopter";
            if (!await UserManager.IsInRoleAsync(user, requiredRole))
            {
                errorMessage = $"This account is not a {requiredRole} account.";
                return;
            }
        }

        var result = await SignInManager.PasswordSignInAsync(user.UserName!, form.Password ?? "", false, false);
        if (!result.Succeeded)
        {
            errorMessage = "Invalid login attempt.";
            return;
        }

        Nav.NavigateTo(ResolvePostLoginTarget(), replace: true);
    }

    private async Task HandleRegister()
    {
        if (!string.Equals(form.Password, form.ConfirmPassword, StringComparison.Ordinal))
        {
            errorMessage = "Passwords do not match.";
            return;
        }

        var email = (form.Email ?? "").Trim();
        if (string.IsNullOrWhiteSpace(email))
        {
            errorMessage = "Email is required.";
            return;
        }

        if (authType == AuthType.Shelter && string.IsNullOrWhiteSpace(form.ShelterName))
        {
            errorMessage = "Shelter name is required.";
            return;
        }

        if (authType == AuthType.Adopter && string.IsNullOrWhiteSpace(form.AdopterName))
        {
            errorMessage = "Adopter name is required.";
            return;
        }

        var user = new ApplicationUser
        {
            UserName = email,
            Email = email,
            EmailConfirmed = true
        };

        var create = await UserManager.CreateAsync(user, form.Password ?? "");
        if (!create.Succeeded)
        {
            errorMessage = string.Join(" ", create.Errors.Select(e => e.Description));
            return;
        }

        if (authType == AuthType.Adopter)
        {
            await UserManager.AddToRoleAsync(user, "Adopter");
            await UserManager.AddClaimAsync(user, new Claim("FullName", form.AdopterName!.Trim()));
        }
        else
        {
            await UserManager.AddToRoleAsync(user, "Shelter");

            var shelter = new Shelter
            {
                OwnerUserId = user.Id,
                Name = form.ShelterName!.Trim(),
                Address = (form.ShelterAddress ?? "").Trim(),
                Phone = (form.ShelterPhone ?? "").Trim(),
                Description = (form.ShelterDescription ?? "").Trim()
            };

            await ShelterService.CreateShelterForOwnerAsync(shelter);
        }

        await SignInManager.SignInAsync(user, isPersistent: false);

        Nav.NavigateTo(ResolvePostRegisterTarget(), replace: true);
    }

    private string ResolvePostLoginTarget()
    {
        if (!string.IsNullOrWhiteSpace(returnUrl)) return returnUrl!;
        if (isAdminMode) return "/admin/pets";
        if (authType == AuthType.Shelter) return "/shelter/dashboard";
        return "/";
    }

    private string ResolvePostRegisterTarget()
    {
        if (authType == AuthType.Shelter) return "/shelter/dashboard";
        return "/";
    }

    private sealed class AuthForm
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string Email { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required]
        public string Password { get; set; } = "";

        public string ConfirmPassword { get; set; } = "";

        public string? AdopterName { get; set; }

        public string? ShelterName { get; set; }
        public string? ShelterAddress { get; set; }
        public string? ShelterPhone { get; set; }
        public string? ShelterDescription { get; set; }
    }

    private enum AuthType { Adopter, Shelter }
}



