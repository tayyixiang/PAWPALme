@page "/auth"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using PAWPALme.Data
@using PAWPALme.Models
@using PAWPALme.Repositories
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject IShelterRepository ShelterRepo
@inject NavigationManager Nav

<PageTitle>Access | PawPal</PageTitle>

<div class="neumorph-bg">
    <div class="d-flex flex-column align-items-center w-100">

        @* VIEW STATE 1: REGISTER MODE (TOGGLE BUTTONS)
           If the user is trying to register, we show them a choice:
           "Are you an Adopter looking for a pet?" or "Are you a Shelter looking for a home?"
        *@
        @if (Mode != "login")
        {
            <div class="glass-toggle-container">
                <a href="auth?mode=register&role=adopter"
                   class="btn-toggle-role @(Role != "shelter" ? "active" : "")">
                    ADOPTER
                </a>
                <a href="auth?mode=register&role=shelter"
                   class="btn-toggle-role @(Role == "shelter" ? "active" : "")">
                    SHELTER
                </a>
            </div>
        }

        @* THE MAIN CARD:
           This container holds the actual forms.
           It dynamically expands (.wide) if we need to show the longer Shelter registration form.
        *@
        <div class="auth-card @(Role == "shelter" && Mode != "login" ? "wide" : "")">

            <div class="text-center">
                @* DYNAMIC ICON: Changes based on role (House for Shelter, Heart for Adopter) *@
                <div class="header-icon-wrapper @(Role == "shelter" ? "shelter" : "")">
                    @if (Role == "shelter")
                    {
                        <i class="bi bi-shop-window"></i>
                    }
                    else
                    {
                        <i class="bi bi-person-heart"></i>
                    }
                </div>
                <h2 class="fw-bold text-dark mb-1">
                    @(Mode == "login" ? "Welcome Back" : (Role == "shelter" ? "Partner Program" : "Join PawPal"))
                </h2>
                <p class="text-muted small mb-4">
                    @(Mode == "login" ? "Log in to access your dashboard" : (Role == "shelter" ? "Register your shelter to manage pets" : "Find your player 2 today"))
                </p>
            </div>

            @* GLOBAL ERROR MESSAGE: Displays validation errors like "Invalid Password" *@
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger py-2 small text-center rounded-pill mb-4">@ErrorMessage</div>
            }

            @* ---------------------------------------------------- *@
            @* FORM 1: LOGIN *@
            @* ---------------------------------------------------- *@
            @if (Mode == "login")
            {
                <EditForm Model="LoginModel" OnValidSubmit="LoginUser" FormName="login-form">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger small list-unstyled text-center mb-3" />

                    <div class="vstack gap-3">
                        <div class="input-group-custom">
                            <i class="bi bi-envelope input-icon"></i>
                            <InputText @bind-Value="LoginModel.Email" class="form-input" placeholder="Email Address" />
                        </div>
                        <div class="input-group-custom">
                            <i class="bi bi-lock input-icon"></i>
                            <InputText type="password" @bind-Value="LoginModel.Password" class="form-input" placeholder="Password" />
                        </div>

                        <div class="d-flex justify-content-end mt-n2 mb-2">
                            <a href="#" class="small text-decoration-none text-muted">Forgot password?</a>
                        </div>

                        <button type="submit" class="liquid-btn mt-3">Log In</button>
                    </div>
                </EditForm>

                <div class="text-center mt-4 pt-3 border-top border-light">
                    <p class="text-muted small mb-0">
                        New User? <a href="auth?mode=register&role=adopter" class="toggle-link ms-1">Create Account</a>
                    </p>
                </div>
            }

            @* ---------------------------------------------------- *@
            @* FORM 2: REGISTER ADOPTER (SIMPLE) *@
            @* ---------------------------------------------------- *@
            else if (Mode == "register" && Role != "shelter")
            {
                <EditForm Model="AdopterModel" OnValidSubmit="RegisterAdopter" FormName="adopter-form">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger small list-unstyled text-center mb-3" />

                    <div class="vstack gap-3">
                        <div class="input-group-custom">
                            <i class="bi bi-person input-icon"></i>
                            <InputText @bind-Value="AdopterModel.FullName" class="form-input" placeholder="Full Name" />
                        </div>
                        <div class="input-group-custom">
                            <i class="bi bi-envelope input-icon"></i>
                            <InputText @bind-Value="AdopterModel.Email" class="form-input" placeholder="Email Address" />
                        </div>
                        <div class="input-group-custom">
                            <i class="bi bi-lock input-icon"></i>
                            <InputText type="password" @bind-Value="AdopterModel.Password" class="form-input" placeholder="Create Password" />
                        </div>

                        <button type="submit" class="liquid-btn mt-3">Create Account</button>
                    </div>
                </EditForm>

                <div class="text-center mt-4 pt-3 border-top border-light">
                    <p class="text-muted small mb-0">
                        Already Registered? <a href="auth?mode=login" class="toggle-link ms-1">Log In</a>
                    </p>
                </div>
            }

            @* ---------------------------------------------------- *@
            @* FORM 3: REGISTER SHELTER (COMPLEX) *@
            @* ---------------------------------------------------- *@
            else if (Mode == "register" && Role == "shelter")
            {
                <EditForm Model="ShelterModel" OnValidSubmit="RegisterShelter" FormName="shelter-form">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger small list-unstyled text-center mb-3" />

                    <div class="vstack gap-3">
                        <div class="input-group-custom">
                            <i class="bi bi-shop input-icon"></i>
                            <InputText @bind-Value="ShelterModel.ShelterName" class="form-input" placeholder="Shelter Name" />
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="input-group-custom m-0">
                                    <i class="bi bi-telephone input-icon"></i>
                                    <InputText @bind-Value="ShelterModel.Phone" class="form-input" placeholder="Phone" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group-custom m-0">
                                    <i class="bi bi-geo-alt input-icon"></i>
                                    <InputText @bind-Value="ShelterModel.Address" class="form-input" placeholder="Address" />
                                </div>
                            </div>
                        </div>

                        <div class="input-group-custom">
                            <i class="bi bi-envelope input-icon"></i>
                            <InputText @bind-Value="ShelterModel.Email" class="form-input" placeholder="Email Address" />
                        </div>
                        <div class="input-group-custom">
                            <i class="bi bi-lock input-icon"></i>
                            <InputText type="password" @bind-Value="ShelterModel.Password" class="form-input" placeholder="Create Password" />
                        </div>

                        <button type="submit" class="liquid-btn mt-3">Register Shelter</button>
                    </div>
                </EditForm>

                <div class="text-center mt-4 pt-3 border-top border-light">
                    <p class="text-muted small mb-0">
                        Already Registered? <a href="auth?mode=login" class="toggle-link ms-1">Log In</a>
                    </p>
                </div>
            }

        </div>
    </div>
</div>

@code {
    // URL STATE MANAGEMENT:
    // Instead of separate pages (Login.razor, Register.razor), I use Query Parameters (?mode=login).
    // This allows me to animate transitions between forms on a single page.
    [SupplyParameterFromQuery]
    public string? Mode { get; set; } // "login" or "register"

    [SupplyParameterFromQuery]
    public string? Role { get; set; } // "adopter" or "shelter"

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; } // Handles "redirect back after login"

    private string? ErrorMessage;

    protected override void OnInitialized()
    {
        // Default to login mode if URL is empty
        if (string.IsNullOrEmpty(Mode)) Mode = "login";
    }

    // FORM MODELS:
    // I use separate models for each form to avoid validation conflicts.
    // e.g. Shelter form requires 'Address', but Login form does not.
    [SupplyParameterFromForm(FormName = "login-form")]
    public LoginInput LoginModel { get; set; } = new();

    [SupplyParameterFromForm(FormName = "adopter-form")]
    public AdopterInput AdopterModel { get; set; } = new();

    [SupplyParameterFromForm(FormName = "shelter-form")]
    public ShelterInput ShelterModel { get; set; } = new();

    // --- LOGIC: LOGIN ---
    public async Task LoginUser()
    {
        var user = await UserManager.FindByEmailAsync(LoginModel.Email);
        if (user == null)
        {
            ErrorMessage = "Invalid login credentials.";
            return;
        }

        // 'PasswordSignInAsync' checks the hash. 'false' means "Don't remember me" (cookie expires on close).
        var result = await SignInManager.PasswordSignInAsync(user, LoginModel.Password, false, lockoutOnFailure: false);

        if (result.Succeeded)
        {
            // INTELLIGENT REDIRECT:
            // 1. If user was kicked here from a specific page (e.g. Booking), send them back there.
            if (!string.IsNullOrEmpty(ReturnUrl))
            {
                Nav.NavigateTo(ReturnUrl, forceLoad: true);
                return;
            }

            // 2. Otherwise, check their role. Shelters go to Dashboard, Adopters go Home.
            var roles = await UserManager.GetRolesAsync(user);
            if (roles.Contains("Shelter"))
            {
                Nav.NavigateTo("/shelter/dashboard", forceLoad: true);
            }
            else
            {
                Nav.NavigateTo("/", forceLoad: true);
            }
        }
        else
        {
            ErrorMessage = "Invalid login credentials.";
        }
    }

    // --- LOGIC: REGISTER ADOPTER ---
    public async Task RegisterAdopter()
    {
        var user = new ApplicationUser { UserName = AdopterModel.Email, Email = AdopterModel.Email, FullName = AdopterModel.FullName };

        // This automatically hashes the password before saving
        var result = await UserManager.CreateAsync(user, AdopterModel.Password);

        if (result.Succeeded)
        {
            // Auto-login after successful registration
            await SignInManager.SignInAsync(user, isPersistent: false);
            Nav.NavigateTo("/", forceLoad: true);
        }
        else ErrorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
    }

    // --- LOGIC: REGISTER SHELTER ---
    public async Task RegisterShelter()
    {
        // Ensure the "Shelter" role actually exists in the database
        if (!await RoleManager.RoleExistsAsync("Shelter")) await RoleManager.CreateAsync(new IdentityRole("Shelter"));

        // 1. Create the User Account (Login details)
        var user = new ApplicationUser { UserName = ShelterModel.Email, Email = ShelterModel.Email, FullName = ShelterModel.ShelterName };
        var result = await UserManager.CreateAsync(user, ShelterModel.Password);

        if (result.Succeeded)
        {
            // 2. Assign the Role
            await UserManager.AddToRoleAsync(user, "Shelter");

            // 3. Create the Shelter Profile (Business details)
            var shelter = new Shelter { Name = ShelterModel.ShelterName, Address = ShelterModel.Address, Phone = ShelterModel.Phone, OwnerUserId = user.Id };
            await ShelterRepo.AddAsync(shelter);

            // 4. Link User -> Shelter (Foreign Key update)
            user.ShelterId = shelter.Id;
            await UserManager.UpdateAsync(user);

            // 5. Login & Redirect
            await SignInManager.SignInAsync(user, isPersistent: false);
            Nav.NavigateTo("/shelter/dashboard", forceLoad: true);
        }
        else ErrorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
    }

    // --- DATA TRANSFER OBJECTS (DTOs) ---
    public class LoginInput
    {
        [Required] public string Email { get; set; } = "";
        [Required] public string Password { get; set; } = "";
    }
    public class AdopterInput
    {
        [Required] public string FullName { get; set; } = "";
        [Required, EmailAddress] public string Email { get; set; } = "";
        [Required] public string Password { get; set; } = "";
    }
    public class ShelterInput
    {
        [Required, EmailAddress] public string Email { get; set; } = "";
        [Required] public string Password { get; set; } = "";
        [Required] public string ShelterName { get; set; } = "";
        [Required] public string Address { get; set; } = "";
        [Required] public string Phone { get; set; } = "";
    }
}